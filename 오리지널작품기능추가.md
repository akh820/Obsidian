사용자님의 계획은 데이터의 무결성(기록 보존)과 보안을 모두 잡는 아주 깔끔한 설계입니다! 말씀하신 내용을 바탕으로 DB 구조 변경안과 실행 프로세스를 딱 정리해 드릴게요.

---

### 1. DB 구조 변경 (SQL)

도커로 접속한 MySQL 환경에서 아래 명령어를 실행하여 컬럼 2개를 추가하세요.

```sql
ALTER TABLE equipment_requests
ADD COLUMN return_token VARCHAR(255) NULL COMMENT '토큰(날짜_난수)',
ADD COLUMN returned_at DATETIME NULL COMMENT '실제 반납 일시';

```

- **`return_token`**: 말씀하신 대로 `202602171530_aBcD123` 형태의 문자열을 저장합니다.
- **`returned_at`**: 반납 버튼을 누르는 순간의 시간을 기록하여 `processed_at`(승인 시간)과 구분합니다.

---

### 2. 단계별 구현 가이드

#### **1단계: 승인 및 토큰 생성 (Backend)**

관리자가 '승인' 버튼을 누를 때의 로직입니다.

1. `status`를 `반납대기`로 변경.
2. `processed_at`에 현재 시간 저장 (유효기간 시작점).
3. **토큰 생성**: `현재날짜시간(YYYYMMDDHHMMSS)` + `_` + `랜덤문자열`.
4. 생성된 토큰을 `return_token` 컬럼에 저장.

#### **2단계: QR 코드 발급**

- **데이터**: `https://your-domain.com/return?token=202602171530_aBcD123`
- 위 주소를 QR 코드로 변환하여 사용자에게 보여줍니다. (QR 자체가 토큰 정보를 품고 있게 됩니다.)

#### **3단계: 스캔 및 반납 검증 (핵심 로직)**

사용자가 스마트폰으로 QR을 찍고 접속했을 때 서버에서 수행할 체크 리스트입니다.

| 체크 항목          | 판단 기준                                                    |
| ------------------ | ------------------------------------------------------------ |
| **토큰 존재 여부** | DB에 해당 `return_token`이 존재하는가?                       |
| **상태 확인**      | 해당 행의 `status`가 `반납대기`인가? (이미 반납 완료면 거부) |
| **유효 기간**      | 현재 시간과 `processed_at`의 차이가 30일 이내인가?           |

---

### 3. 최종 상태 관리 예시

비품 반납이 완료되면 데이터는 다음과 같이 남게 됩니다:

- **`status`**: `반납완료`
- **`processed_at`**: `2026-02-17 10:00:00` (승인했던 과거 시간 그대로)
- **`returned_at`**: `2026-03-10 14:20:00` (실제 반납한 현재 시간)
- **`return_token`**: `202602171000_zXy9...` (기록 보존)

---

### 💡 한 줄 팁

토큰 앞에 날짜를 넣기로 하셨으니, 나중에 "반납 안 된 지 오래된 비품"을 찾을 때 DB 쿼리를 복잡하게 짤 필요 없이 **`return_token LIKE '202601%'`** 식으로 조회해서 1월달에 승인된 것들만 빠르게 추려낼 수도 있겠네요!

이제 이 로직을 적용하기 위해 **도커 MySQL에서 테이블 구조 변경(ALTER)**부터 시작해 보시겠어요? 아니면 토큰을 생성하는 **Java/Spring(또는 사용 언어) 코드 예시**가 필요하신가요?

또한 모든 앱의 전체 기능을 이용하려면 [Gemini 앱 활동]()을 사용 설정하세요.
